<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABILLON FAMILY ACCESS | WIFI GATEWAY</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* Glitch Animation */
@keyframes glitch {
    0% { transform: translate(0); }
    20% { transform: translate(-5px, 5px); }
    40% { transform: translate(-5px, -5px); }
    60% { transform: translate(5px, 5px); }
    80% { transform: translate(5px, -5px); }
    100% { transform: translate(0); }
}

.denied-glitch {
    animation: glitch 0.2s infinite;
    filter: sepia(100%) saturate(500%) hue-rotate(-50deg) !important;
}

.denied-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 0, 0, 0.2);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: bold; font-size: 24px;
    z-index: 20; text-shadow: 2px 2px #ff0000;
}
        :root { --glow: #00ff41; --bg: #050505; }
        body, html {
            background: var(--bg); color: var(--glow);
            font-family: 'Courier New', monospace;
            height: 100vh; margin: 0; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        #matrix-canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.1; }

        .ui-frame {
            position: relative; z-index: 10;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px; border: 1px solid var(--glow);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.15);
            width: 360px; border-radius: 4px;
        }

        #scanner-container {
            position: relative; width: 320px; height: 320px;
            border: 1px solid var(--glow); background: #000;
            margin: 10px auto; overflow: hidden;
        }

        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); filter: brightness(0.8) contrast(1.2) sepia(1) hue-rotate(80deg); }

        /* Permanent Decorative Grid */
        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--glow) 1px, transparent 1px), linear-gradient(90deg, var(--glow) 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.15; z-index: 5; pointer-events: none;
        }

        #face-box {
            position: absolute; border: 1px solid var(--glow);
            box-shadow: 0 0 10px var(--glow); display: none; z-index: 6;
        }

        .laser {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--glow); box-shadow: 0 0 15px var(--glow);
            z-index: 10; display: none;
        }

        @keyframes scanAnim { 0% { top: 0%; } 100% { top: 100%; } }

        /* Terminal Window */
        .terminal {
            background: rgba(0, 20, 0, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.3);
            height: 80px; padding: 10px; font-size: 11px;
            overflow-y: hidden; text-align: left; margin-bottom: 10px;
        }

        .progress-bar { width: 100%; height: 4px; background: #002200; margin-bottom: 15px; }
        #fill { width: 0%; height: 100%; background: var(--glow); box-shadow: 0 0 10px var(--glow); }
        
        button {
            background: transparent; color: var(--glow); border: 1px solid var(--glow);
            padding: 10px; cursor: pointer; width: 100%; font-family: inherit;
        }
        button:hover:not(:disabled) { background: var(--glow); color: #000; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div class="ui-frame">
    <div style="font-size: 12px; margin-bottom: 5px;">SYS_AUTH_PORTAL_v2.0</div>
    <div id="scanner-container">
        <video id="webcam" autoplay playsinline muted></video>
        <div class="grid-overlay"></div>
        <div id="face-box"></div>
        <div id="laser" class="laser"></div>
    </div>

    <div class="terminal" id="term-log">
        > SYSTEM STANDBY...<br>
        > WAITING FOR BIOMETRIC INPUT...
    </div>

    <div class="progress-bar"><div id="fill"></div></div>
    <button id="scanBtn" onclick="startScan()" disabled>INITIALIZING...</button>
</div>

<script>
const video = document.getElementById('webcam');
const faceBox = document.getElementById('face-box');
const laser = document.getElementById('laser');
const term = document.getElementById('term-log');
const fill = document.getElementById('fill');
const scanBtn = document.getElementById('scanBtn');
let detector;

function log(msg) {
    const line = document.createElement('div');
    line.innerHTML = `> ${msg}`;
    term.appendChild(line);
    term.scrollTop = term.scrollHeight;
}

// 1. Matrix Background Logic
const canvas = document.getElementById('matrix-canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;
const drops = Array(Math.floor(canvas.width/16)).fill(1);
function drawMatrix() {
    ctx.fillStyle = "rgba(0,0,0,0.05)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#0F0"; drops.forEach((y, i) => {
        ctx.fillText(String.fromCharCode(0x30A0 + Math.random()*96), i*16, y*16);
        if(y*16 > canvas.height && Math.random() > 0.975) drops[i] = 0; drops[i]++;
    });
}
setInterval(drawMatrix, 50);

// 2. Setup Face Tracking with Fallback
async function setup() {
    log("CAMERA_LINK_OK");
    log("DOWNLOADING_AI_MODELS...");
    
    // Fallback: If AI fails to load in 5 seconds, enable button anyway
    setTimeout(() => {
        if (!detector) {
            log("AI_TIMEOUT: MANUAL_MODE_READY");
            enableButton();
        }
    }, 5000);

    try {
        if (window.face_detection) {
            const model = window.face_detection.SupportedModels.MediaPipeFaceDetector;
            detector = await window.face_detection.createDetector(model, {
                runtime: 'mediapipe', 
                solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/face_detection'
            });
            log("NEURAL_ENGINE_ONLINE");
            enableButton();
            render();
        } else {
            log("ERR: CDN_UNREACHABLE");
            enableButton(); // Allow bypass
        }
    } catch(e) { 
        log("ERR: INIT_FAILED");
        enableButton(); 
    }
}

function enableButton() {
    scanBtn.disabled = false;
    scanBtn.innerText = "START BIOMETRIC SCAN";
    scanBtn.style.borderColor = "#00ff41";
}

async function render() {
    if(detector) {
        try {
            const faces = await detector.estimateFaces(video);
            if(faces.length > 0) {
                const face = faces[0].box;
                faceBox.style.display = 'block';
                faceBox.style.width = face.width + 'px';
                faceBox.style.height = face.height + 'px';
                faceBox.style.left = (video.offsetWidth - face.xMax) + 'px';
                faceBox.style.top = face.yMin + 'px';
            } else { faceBox.style.display = 'none'; }
        } catch(e) {}
    }
    requestAnimationFrame(render);
}

// 3. The Scan Animation
function startScan() {
    scanBtn.disabled = true;
    laser.style.display = 'block';
    laser.style.animation = 'scanAnim 2s linear infinite';
    log("EXTRACTING_FACIAL_HASH...");
    
    let p = 0;
    const interval = setInterval(() => {
        p += 1;
        fill.style.width = p + '%';
        if(p == 30) log("HANDSHAKE_ROUTER_01...");
        if(p == 60) log("BYPASSING_FIREWALL...");
        if(p == 90) log("VERIFYING_HARDWARE...");
        
        if(p >= 100) {
            clearInterval(interval);
            laser.style.display = 'none';
            triggerPhysicalBiometrics(); 
        }
    }, 40);
}

// 4. BIOMETRICS
async function triggerPhysicalBiometrics() {
    log("CALLING_SYSTEM_ID...");
    
    if (window.PublicKeyCredential) {
        try {
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            const options = {
                publicKey: {
                    challenge: challenge,
                    rp: { name: "Home WiFi" },
                    user: { id: Uint8Array.from("1", c => c.charCodeAt(0)), name: "user", displayName: "User" },
                    pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                    authenticatorSelection: { userVerification: "required" },
                    timeout: 10000 // 10 second timeout
                }
            };
            await navigator.credentials.create(options);
            showSuccessScreen();
        } catch (err) {
            log("SECURITY_BREACH_DETECTED");
            triggerSelfDestruct();
        }
    } else {
        showSuccessScreen();
    }
}

function triggerSelfDestruct() {
    const frame = document.querySelector('.ui-frame');
    
    // Add glitch class
    frame.classList.add('denied-glitch');
    
    // Add red overlay
    const overlay = document.createElement('div');
    overlay.className = 'denied-overlay';
    overlay.innerHTML = 'ACCESS DENIED';
    frame.appendChild(overlay);

    // After 3 seconds, reset the page
    setTimeout(() => {
        location.reload();
    }, 3000);
}
function showSuccessScreen() {
    document.querySelector('.ui-frame').innerHTML = `
        <h2 style="color:#00ff41; letter-spacing: 2px;">NETWORK_MAP_ACTIVE</h2>
        <canvas id="networkCanvas" style="width: 100%; height: 180px; background: #000; border: 1px solid #004400;"></canvas>
        
        <div id="qr-container" style="display:none; background: white; padding: 10px; margin: 10px auto; width: 128px; border-radius: 4px;">
            <div id="qrcode"></div>
        </div>

        <div class="terminal" id="success-log" style="height:auto; text-align:left; margin-top:10px; font-size:10px;">
            > ENCRYPTION: WPA3_SECURE<br>
            > NODES_DETECTED: 5 ACTIVE<br>
            > STATUS: ONLINE
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button id="guestBtn" onclick="generateGuestQR()" style="flex: 1;">GUEST_QR</button>
            <button onclick="location.reload()" style="flex: 1;">EXIT</button>
        </div>
    `;

    initNetworkMap();
}

function generateGuestQR() {
    const qrBox = document.getElementById('qr-container');
    const log = document.getElementById('success-log');
    const btn = document.getElementById('guestBtn');

    // Wipe previous QR if it exists
    document.getElementById('qrcode').innerHTML = "";

    // Replace with your actual WiFi details:
    // T: Encryption (WPA), S: SSID, P: Password
    const wifiString = "WIFI:T:WPA;S:Your_WiFi_Name;P:Your_Password;;";

    new QRCode(document.getElementById("qrcode"), {
        text: wifiString,
        width: 128,
        height: 128,
        colorDark : "#000000",
        colorLight : "#ffffff",
    });

    qrBox.style.display = "block";
    log.innerHTML = "> GENERATING_GUEST_TOKEN...<br>> QR_CODE_READY_FOR_SCAN";
    btn.style.display = "none"; // Hide button after use
}

function initNetworkMap() {
    const canvas = document.getElementById('networkCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    const nodes = [];
    const center = { x: canvas.width / 2, y: canvas.height / 2 };

    // Create fake devices
    for (let i = 0; i < 5; i++) {
        nodes.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            name: ["iPhone", "MacBook", "SmartTV", "IoT_Hub", "Guest"][i]
        });
    }

    function animateMap() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw Router (Center)
        ctx.beginPath();
        ctx.arc(center.x, center.y, 6, 0, Math.PI * 2);
        ctx.fillStyle = "#00ff41";
        ctx.shadowBlur = 15;
        ctx.shadowColor = "#00ff41";
        ctx.fill();
        ctx.closePath();

        nodes.forEach(node => {
            // Move nodes
            node.x += node.vx;
            node.y += node.vy;

            // Bounce off edges
            if (node.x < 0 || node.x > canvas.width) node.vx *= -1;
            if (node.y < 0 || node.y > canvas.height) node.vy *= -1;

            // Draw Connection Lines
            ctx.beginPath();
            ctx.moveTo(center.x, center.y);
            ctx.lineTo(node.x, node.y);
            ctx.strokeStyle = "rgba(0, 255, 65, 0.2)";
            ctx.lineWidth = 1;
            ctx.stroke();

            // Draw Node
            ctx.beginPath();
            ctx.arc(node.x, node.y, 3, 0, Math.PI * 2);
            ctx.fillStyle = "#00ff41";
            ctx.fill();
            
            // Device Label
            ctx.shadowBlur = 0;
            ctx.font = "8px Courier New";
            ctx.fillText(node.name, node.x + 5, node.y - 5);
        });

        requestAnimationFrame(animateMap);
    }
    animateMap();
}

// Start Camera
navigator.mediaDevices.getUserMedia({video: { facingMode: "user" }})
    .then(s => { 
        video.srcObject = s; 
        video.onloadedmetadata = () => {
            video.play();
            setup(); 
        };
    })
    .catch(err => { 
        log("ERR: CAM_ACCESS_DENIED");
    });
</script>
</body>
</html>