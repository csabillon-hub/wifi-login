<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SABILLON FAMILY ACCESS | WIFI GATEWAY</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>
    
    <style>
        :root { --glow: #00ff41; --bg: #050505; }
        body, html {
            background: var(--bg); color: var(--glow);
            font-family: 'Courier New', monospace;
            height: 100vh; margin: 0; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        #matrix-canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.1; }

        .ui-frame {
            position: relative; z-index: 10;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px; border: 1px solid var(--glow);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.15);
            width: 360px; border-radius: 4px;
        }

        #scanner-container {
            position: relative; width: 320px; height: 320px;
            border: 1px solid var(--glow); background: #000;
            margin: 10px auto; overflow: hidden;
        }

        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); filter: brightness(0.8) contrast(1.2) sepia(1) hue-rotate(80deg); }

        /* Permanent Decorative Grid */
        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--glow) 1px, transparent 1px), linear-gradient(90deg, var(--glow) 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.15; z-index: 5; pointer-events: none;
        }

        #face-box {
            position: absolute; border: 1px solid var(--glow);
            box-shadow: 0 0 10px var(--glow); display: none; z-index: 6;
        }

        .laser {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--glow); box-shadow: 0 0 15px var(--glow);
            z-index: 10; display: none;
        }

        @keyframes scanAnim { 0% { top: 0%; } 100% { top: 100%; } }

        /* Terminal Window */
        .terminal {
            background: rgba(0, 20, 0, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.3);
            height: 80px; padding: 10px; font-size: 11px;
            overflow-y: hidden; text-align: left; margin-bottom: 10px;
        }

        .progress-bar { width: 100%; height: 4px; background: #002200; margin-bottom: 15px; }
        #fill { width: 0%; height: 100%; background: var(--glow); box-shadow: 0 0 10px var(--glow); }
        
        button {
            background: transparent; color: var(--glow); border: 1px solid var(--glow);
            padding: 10px; cursor: pointer; width: 100%; font-family: inherit;
        }
        button:hover:not(:disabled) { background: var(--glow); color: #000; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div class="ui-frame">
    <div style="font-size: 12px; margin-bottom: 5px;">SYS_AUTH_PORTAL_v2.0</div>
    <div id="scanner-container">
        <video id="webcam" autoplay playsinline muted></video>
        <div class="grid-overlay"></div>
        <div id="face-box"></div>
        <div id="laser" class="laser"></div>
    </div>

    <div class="terminal" id="term-log">
        > SYSTEM STANDBY...<br>
        > WAITING FOR BIOMETRIC INPUT...
    </div>

    <div class="progress-bar"><div id="fill"></div></div>
    <button id="scanBtn" onclick="startScan()" disabled>INITIALIZING...</button>
</div>

<script>
// --- ALL-IN-ONE UPDATED SCRIPT ---
const video = document.getElementById('webcam');
const faceBox = document.getElementById('face-box');
const laser = document.getElementById('laser');
const term = document.getElementById('term-log');
const fill = document.getElementById('fill');
const scanBtn = document.getElementById('scanBtn');
let detector;

function log(msg) {
    const line = document.createElement('div');
    line.innerHTML = `> ${msg}`;
    term.appendChild(line);
    term.scrollTop = term.scrollHeight;
}

// 1. Matrix Background Logic
const canvas = document.getElementById('matrix-canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;
const drops = Array(Math.floor(canvas.width/16)).fill(1);
function drawMatrix() {
    ctx.fillStyle = "rgba(0,0,0,0.05)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#0F0"; drops.forEach((y, i) => {
        ctx.fillText(String.fromCharCode(0x30A0 + Math.random()*96), i*16, y*16);
        if(y*16 > canvas.height && Math.random() > 0.975) drops[i] = 0; drops[i]++;
    });
}
setInterval(drawMatrix, 50);

// 2. Setup Face Tracking
async function setup() {
    try {
        const model = window.face_detection.SupportedModels.MediaPipeFaceDetector;
        detector = await window.face_detection.createDetector(model, {
            runtime: 'mediapipe', solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/face_detection'
        });
        log("NEURAL_LINK_ESTABLISHED");
        scanBtn.disabled = false;
        scanBtn.innerText = "START BIOMETRIC SCAN";
        render();
    } catch(e) { log("ERR: MOD_LOAD_FAIL"); }
}

async function render() {
    if(detector) {
        const faces = await detector.estimateFaces(video);
        if(faces.length > 0) {
            const face = faces[0].box;
            faceBox.style.display = 'block';
            faceBox.style.width = face.width + 'px';
            faceBox.style.height = face.height + 'px';
            faceBox.style.left = (video.offsetWidth - face.xMax) + 'px';
            faceBox.style.top = face.yMin + 'px';
        } else { faceBox.style.display = 'none'; }
    }
    requestAnimationFrame(render);
}

// 3. The Scan Animation
function startScan() {
    laser.style.display = 'block';
    laser.style.animation = 'scanAnim 2s linear infinite';
    log("SCANNING FACIAL MESH...");
    
    let p = 0;
    const interval = setInterval(() => {
        p += 1;
        fill.style.width = p + '%';
        if(p == 25) log("ISOLATING_FEATURES...");
        if(p == 50) log("COMPARING_HASH...");
        if(p == 75) log("ENCRYPTING_SESSION...");
        
        if(p >= 100) {
            clearInterval(interval);
            laser.style.display = 'none';
            triggerPhysicalBiometrics(); // CALL THE REAL FACE ID HERE
        }
    }, 40);
}

// 4. THE ACTUAL SYSTEM FACE ID TRIGGER
async function triggerPhysicalBiometrics() {
    log("REQUESTING_SYSTEM_AUTH...");
    
    if (window.PublicKeyCredential) {
        try {
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            const options = {
                publicKey: {
                    challenge: challenge,
                    rp: { name: "Home WiFi" },
                    user: {
                        id: Uint8Array.from("1", c => c.charCodeAt(0)),
                        name: "user", displayName: "User"
                    },
                    pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                    authenticatorSelection: { userVerification: "required" },
                    timeout: 60000
                }
            };

            await navigator.credentials.create(options);
            log("SUCCESS: ACCESS_GRANTED");
            showSuccessScreen();
        } catch (err) {
            log("ERR: AUTH_CANCELLED");
        }
    } else {
        showSuccessScreen();
    }
}

function showSuccessScreen() {
    document.querySelector('.ui-frame').innerHTML = `
        <h2 style="color:#00ff41">ACCESS GRANTED</h2>
        <div style="border:1px solid #00ff41; padding:20px; background:rgba(0,40,0,0.5); text-align:left;">
            <p>> SSID: HOME_WIFI_6</p>
            <p>> STATUS: SECURE_LINK</p>
            <p>> ENCRYPTION: AES-256</p>
        </div>
        <button onclick="location.reload()" style="margin-top:20px">RESET SYSTEM</button>
    `;
}

// Start Camera on load
navigator.mediaDevices.getUserMedia({video: true}).then(s => { 
    video.srcObject = s; video.onloadedmetadata = setup; 
});
</script>
</body>
</html>